apiVersion: v1
kind: Namespace
metadata:
  name: smart-home
  labels:
    name: smart-home
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: home-assistant
  namespace: smart-home
spec:
  replicas: 1
  selector:
    matchLabels:
      app: home-assistant
  template:
    metadata:
      labels:
        app: home-assistant
    spec:
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            preference:
              matchExpressions:
              - key: kubernetes.io/arch
                operator: In
                values:
                - arm64
      containers:
      - name: home-assistant
        image: ghcr.io/home-assistant/home-assistant:2024.1
        ports:
        - containerPort: 8123
          name: web
        env:
        - name: TZ
          value: America/New_York
        volumeMounts:
        - name: config
          mountPath: /config
        - name: media
          mountPath: /media
        resources:
          requests:
            cpu: 200m
            memory: 512Mi
          limits:
            cpu: 1000m
            memory: 2Gi
        securityContext:
          privileged: true
        livenessProbe:
          httpGet:
            path: /
            port: 8123
          initialDelaySeconds: 30
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /
            port: 8123
          initialDelaySeconds: 15
          periodSeconds: 15
      volumes:
      - name: config
        persistentVolumeClaim:
          claimName: home-assistant-config
      - name: media
        persistentVolumeClaim:
          claimName: media-storage
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: home-assistant-config
  namespace: smart-home
data:
  configuration.yaml: "# Home Assistant Configuration for Homelab\n\n# Default config\n\
    default_config:\n\n# Homelab integration\nhomelab:\n  name: \"Multi-Architecture\
    \ Homelab\"\n  latitude: 40.7128\n  longitude: -74.0060\n  elevation: 10\n  unit_system:\
    \ metric\n  time_zone: America/New_York\n  \n# HTTP configuration\nhttp:\n  use_x_forwarded_for:\
    \ true\n  trusted_proxies:\n    - 10.0.0.0/8\n    - 172.16.0.0/12\n    - 192.168.0.0/16\n\
    \n# Prometheus metrics export\nprometheus:\n  namespace: homelab\n  filter:\n\
    \    include_domains:\n      - sensor\n      - binary_sensor\n      - light\n\
    \      - switch\n      - climate\n      - device_tracker\n\n# MQTT for IoT devices\n\
    mqtt:\n  broker: edge-mqtt.edge.svc.cluster.local\n  port: 1883\n  username: edge\n\
    \  password: edgepassword\n  discovery: true\n  discovery_prefix: homeassistant\n\
    \n# Recorder for database\nrecorder:\n  db_url: postgresql://homeassistant:homeassistant@postgres:5432/homeassistant\n\
    \  purge_keep_days: 30\n  auto_purge: true\n  \n# History\nhistory:\n  include:\n\
    \    domains:\n      - sensor\n      - binary_sensor\n      - light\n      - switch\n\
    \      - climate\n\n# Logbook\nlogbook:\n  exclude:\n    domains:\n      - automation\n\
    \      - script\n\n# Energy monitoring\nenergy:\n  \n# Scenes\nscene: !include\
    \ scenes.yaml\n\n# Automations\nautomation: !include automations.yaml\n\n# Scripts\n\
    script: !include scripts.yaml\n\n# Groups\ngroup: !include groups.yaml\n\n# Sensors\n\
    sensor:\n  # Homelab cluster metrics\n  - platform: rest\n    name: \"Cluster\
    \ CPU Usage\"\n    resource: http://prometheus.monitoring:9090/api/v1/query?query=avg(100%20-%20(irate(node_cpu_seconds_total{mode=\"\
    idle\"}[5m])%20*%20100))\n    value_template: \"{{ value_json.data.result[0].value[1]\
    \ | round(1) }}\"\n    unit_of_measurement: \"%\"\n    \n  - platform: rest\n\
    \    name: \"Cluster Memory Usage\"\n    resource: http://prometheus.monitoring:9090/api/v1/query?query=avg((1%20-%20(node_memory_MemAvailable_bytes%20/%20node_memory_MemTotal_bytes))%20*%20100)\n\
    \    value_template: \"{{ value_json.data.result[0].value[1] | round(1) }}\"\n\
    \    unit_of_measurement: \"%\"\n    \n  - platform: rest\n    name: \"Cluster\
    \ Power Consumption\"\n    resource: http://prometheus.monitoring:9090/api/v1/query?query=sum(node_power_consumption_watts)\n\
    \    value_template: \"{{ value_json.data.result[0].value[1] | round(1) }}\"\n\
    \    unit_of_measurement: \"W\"\n    \n  - platform: rest\n    name: \"GPU Utilization\"\
    \n    resource: http://prometheus.monitoring:9090/api/v1/query?query=avg(DCGM_FI_DEV_GPU_UTIL)\n\
    \    value_template: \"{{ value_json.data.result[0].value[1] | round(1) }}\"\n\
    \    unit_of_measurement: \"%\"\n    \n  # Room Temperature Sensors\n  - platform:\
    \ mqtt\n    name: \"Living Room Temperature\"\n    state_topic: \"homeassistant/sensor/living_room_temp/state\"\
    \n    unit_of_measurement: \"\xB0C\"\n    device_class: temperature\n    \n  -\
    \ platform: mqtt\n    name: \"Bedroom Temperature\"\n    state_topic: \"homeassistant/sensor/bedroom_temp/state\"\
    \n    unit_of_measurement: \"\xB0C\"\n    device_class: temperature\n    \n  -\
    \ platform: mqtt\n    name: \"Kitchen Temperature\"\n    state_topic: \"homeassistant/sensor/kitchen_temp/state\"\
    \n    unit_of_measurement: \"\xB0C\"\n    device_class: temperature\n    \n  -\
    \ platform: mqtt\n    name: \"Office Temperature\"\n    state_topic: \"homeassistant/sensor/office_temp/state\"\
    \n    unit_of_measurement: \"\xB0C\"\n    device_class: temperature\n    \n  -\
    \ platform: mqtt\n    name: \"Server Room Temperature\"\n    state_topic: \"homeassistant/sensor/server_room_temp/state\"\
    \n    unit_of_measurement: \"\xB0C\"\n    device_class: temperature\n    \n  #\
    \ Humidity Sensors\n  - platform: mqtt\n    name: \"Living Room Humidity\"\n \
    \   state_topic: \"homeassistant/sensor/living_room_humidity/state\"\n    unit_of_measurement:\
    \ \"%\"\n    device_class: humidity\n    \n  - platform: mqtt\n    name: \"Bedroom\
    \ Humidity\"\n    state_topic: \"homeassistant/sensor/bedroom_humidity/state\"\
    \n    unit_of_measurement: \"%\"\n    device_class: humidity\n    \n  - platform:\
    \ mqtt\n    name: \"Kitchen Humidity\"\n    state_topic: \"homeassistant/sensor/kitchen_humidity/state\"\
    \n    unit_of_measurement: \"%\"\n    device_class: humidity\n    \n  # HVAC Power\
    \ Consumption Sensors\n  - platform: mqtt\n    name: \"Main HVAC Power\"\n   \
    \ state_topic: \"homeassistant/sensor/main_hvac_power/state\"\n    unit_of_measurement:\
    \ \"W\"\n    device_class: power\n    \n  - platform: mqtt\n    name: \"Zone 1\
    \ HVAC Power\"\n    state_topic: \"homeassistant/sensor/zone1_hvac_power/state\"\
    \n    unit_of_measurement: \"W\"\n    device_class: power\n    \n  - platform:\
    \ mqtt\n    name: \"Zone 2 HVAC Power\"\n    state_topic: \"homeassistant/sensor/zone2_hvac_power/state\"\
    \n    unit_of_measurement: \"W\"\n    device_class: power\n    \n  # Energy Sensors\n\
    \  - platform: mqtt\n    name: \"Total HVAC Energy\"\n    state_topic: \"homeassistant/sensor/total_hvac_energy/state\"\
    \n    unit_of_measurement: \"kWh\"\n    device_class: energy\n    state_class:\
    \ total_increasing\n    \n  - platform: mqtt\n    name: \"Lighting Energy\"\n\
    \    state_topic: \"homeassistant/sensor/lighting_energy/state\"\n    unit_of_measurement:\
    \ \"kWh\"\n    device_class: energy\n    state_class: total_increasing\n    \n\
    \  # Template sensors for homelab\n  - platform: template\n    sensors:\n    \
    \  homelab_efficiency:\n        friendly_name: \"Homelab Efficiency\"\n      \
    \  value_template: >-\n          {% set cpu = states('sensor.cluster_cpu_usage')\
    \ | float %}\n          {% set power = states('sensor.cluster_power_consumption')\
    \ | float %}\n          {% if power > 0 %}\n            {{ (cpu / power * 100)\
    \ | round(1) }}\n          {% else %}\n            0\n          {% endif %}\n\
    \        unit_of_measurement: \"CPU%/W\"\n        \n      average_indoor_temperature:\n\
    \        friendly_name: \"Average Indoor Temperature\"\n        value_template:\
    \ >-\n          {% set temps = [\n            states('sensor.living_room_temperature')\
    \ | float(0),\n            states('sensor.bedroom_temperature') | float(0),\n\
    \            states('sensor.kitchen_temperature') | float(0),\n            states('sensor.office_temperature')\
    \ | float(0)\n          ] %}\n          {% set valid_temps = temps | select('>',\
    \ 0) | list %}\n          {% if valid_temps | length > 0 %}\n            {{ (valid_temps\
    \ | sum / valid_temps | length) | round(1) }}\n          {% else %}\n        \
    \    0\n          {% endif %}\n        unit_of_measurement: \"\xB0C\"\n      \
    \  device_class: temperature\n        \n      total_hvac_runtime_today:\n    \
    \    friendly_name: \"Total HVAC Runtime Today\"\n        value_template: >-\n\
    \          {% set heating = states('sensor.heating_runtime_today') | float(0)\
    \ %}\n          {% set cooling = states('sensor.cooling_runtime_today') | float(0)\
    \ %}\n          {{ (heating + cooling) | round(1) }}\n        unit_of_measurement:\
    \ \"hours\"\n        \n      hvac_efficiency_score:\n        friendly_name: \"\
    HVAC Efficiency Score\"\n        value_template: >-\n          {% set energy =\
    \ states('sensor.total_hvac_energy') | float(1) %}\n          {% set runtime =\
    \ states('sensor.total_hvac_runtime_today') | float(1) %}\n          {% if runtime\
    \ > 0 %}\n            {{ (10 - (energy / runtime)) | round(1) | max(0) | min(10)\
    \ }}\n          {% else %}\n            10\n          {% endif %}\n        unit_of_measurement:\
    \ \"score\"\n        \n# Binary sensors\nbinary_sensor:\n  # Homelab service health\n\
    \  - platform: rest\n    name: \"Dashboard Health\"\n    resource: http://dashboard-api.default:8080/health\n\
    \    \n  - platform: rest\n    name: \"ML Serving Health\"\n    resource: http://tensorflow-serving-amd64.ml-serving:8501/v1/models\n\
    \    \n  - platform: rest\n    name: \"Monitoring Health\"\n    resource: http://prometheus.monitoring:9090/-/healthy\n\
    \n# Switches for homelab control\nswitch:\n  # Placeholder for homelab service\
    \ controls\n  - platform: template\n    switches:\n      homelab_backup:\n   \
    \     friendly_name: \"Trigger Backup\"\n        value_template: \"{{ states('input_boolean.backup_running')\
    \ }}\"\n        turn_on:\n          service: shell_command.trigger_backup\n  \
    \      turn_off:\n          service: input_boolean.turn_off\n          entity_id:\
    \ input_boolean.backup_running\n\n# Shell commands for homelab operations\nshell_command:\n\
    \  trigger_backup: >-\n    kubectl create job backup-$(date +%Y%m%d-%H%M%S) \n\
    \    --from=cronjob/velero-backup -n velero\n  restart_service: >-\n    kubectl\
    \ rollout restart deployment/{{ service_name }} -n {{ namespace }}\n  \n# Input\
    \ booleans for UI\ninput_boolean:\n  backup_running:\n    name: \"Backup Running\"\
    \n    initial: false\n    \n# Device tracker\ndevice_tracker:\n  - platform: nmap_tracker\n\
    \    hosts: 192.168.1.1/24\n    home_interval: 10\n    \n# Camera integration\
    \ with homelab security\ncamera:\n  - platform: generic\n    still_image_url:\
    \ http://edge-ai-inference.edge:5000/camera/latest\n    name: \"Edge Camera\"\n\
    \    \n# Climate control integration\nclimate:\n  - platform: generic_thermostat\n\
    \    name: \"Server Room Thermostat\"\n    heater: switch.server_room_fan\n  \
    \  target_sensor: sensor.server_room_temperature\n    min_temp: 15\n    max_temp:\
    \ 30\n    target_temp: 22\n    \n  - platform: mqtt\n    name: \"Living Room Thermostat\"\
    \n    current_temperature_topic: \"homeassistant/sensor/living_room_temp/state\"\
    \n    temperature_command_topic: \"homeassistant/climate/living_room/target_temp\"\
    \n    temperature_state_topic: \"homeassistant/climate/living_room/target_temp/state\"\
    \n    mode_command_topic: \"homeassistant/climate/living_room/mode\"\n    mode_state_topic:\
    \ \"homeassistant/climate/living_room/mode/state\"\n    action_topic: \"homeassistant/climate/living_room/action/state\"\
    \n    modes:\n      - \"off\"\n      - \"heat\"\n      - \"cool\"\n      - \"\
    auto\"\n    min_temp: 15\n    max_temp: 30\n    temp_step: 0.5\n    \n  - platform:\
    \ mqtt\n    name: \"Bedroom Thermostat\"\n    current_temperature_topic: \"homeassistant/sensor/bedroom_temp/state\"\
    \n    temperature_command_topic: \"homeassistant/climate/bedroom/target_temp\"\
    \n    temperature_state_topic: \"homeassistant/climate/bedroom/target_temp/state\"\
    \n    mode_command_topic: \"homeassistant/climate/bedroom/mode\"\n    mode_state_topic:\
    \ \"homeassistant/climate/bedroom/mode/state\"\n    action_topic: \"homeassistant/climate/bedroom/action/state\"\
    \n    modes:\n      - \"off\"\n      - \"heat\"\n      - \"cool\"\n      - \"\
    auto\"\n    min_temp: 15\n    max_temp: 30\n    temp_step: 0.5\n    \n  - platform:\
    \ mqtt\n    name: \"Main HVAC Zone\"\n    current_temperature_topic: \"homeassistant/sensor/average_indoor_temperature/state\"\
    \n    temperature_command_topic: \"homeassistant/climate/main_hvac/target_temp\"\
    \n    temperature_state_topic: \"homeassistant/climate/main_hvac/target_temp/state\"\
    \n    mode_command_topic: \"homeassistant/climate/main_hvac/mode\"\n    mode_state_topic:\
    \ \"homeassistant/climate/main_hvac/mode/state\"\n    action_topic: \"homeassistant/climate/main_hvac/action/state\"\
    \n    modes:\n      - \"off\"\n      - \"heat\"\n      - \"cool\"\n      - \"\
    auto\"\n      - \"fan_only\"\n    min_temp: 15\n    max_temp: 30\n    temp_step:\
    \ 0.5\n    \n# Notify\nnotify:\n  - name: homelab_alerts\n    platform: rest\n\
    \    resource: http://alert-webhook.monitoring:8080/homeassistant\n    method:\
    \ POST_JSON\n    \n# Panel for homelab dashboard\npanel_custom:\n  - name: homelab-grafana\n\
    \    sidebar_title: \"Metrics\"\n    sidebar_icon: mdi:chart-line\n    url_path:\
    \ \"grafana\"\n    url: \"http://grafana.monitoring:3000\"\n    \n  - name: homelab-argocd\n\
    \    sidebar_title: \"GitOps\"\n    sidebar_icon: mdi:git\n    url_path: \"argocd\"\
    \n    url: \"http://argocd-server.argocd:80\"\n"
  automations.yaml: "# Homelab Automations\n\n- id: high_cpu_alert\n  alias: \"High\
    \ CPU Usage Alert\"\n  trigger:\n    platform: numeric_state\n    entity_id: sensor.cluster_cpu_usage\n\
    \    above: 85\n    for:\n      minutes: 5\n  action:\n    - service: notify.homelab_alerts\n\
    \      data:\n        title: \"High CPU Usage\"\n        message: \"Cluster CPU\
    \ usage is {{ states('sensor.cluster_cpu_usage') }}%\"\n        \n- id: high_power_consumption\n\
    \  alias: \"High Power Consumption Alert\"\n  trigger:\n    platform: numeric_state\n\
    \    entity_id: sensor.cluster_power_consumption\n    above: 100\n    for:\n \
    \     minutes: 10\n  action:\n    - service: notify.homelab_alerts\n      data:\n\
    \        title: \"High Power Consumption\"\n        message: \"Cluster consuming\
    \ {{ states('sensor.cluster_power_consumption') }}W\"\n        \n- id: service_down_alert\n\
    \  alias: \"Service Down Alert\"\n  trigger:\n    - platform: state\n      entity_id:\
    \ binary_sensor.dashboard_health\n      to: 'off'\n      for:\n        minutes:\
    \ 2\n    - platform: state\n      entity_id: binary_sensor.ml_serving_health\n\
    \      to: 'off'\n      for:\n        minutes: 2\n    - platform: state\n    \
    \  entity_id: binary_sensor.monitoring_health\n      to: 'off'\n      for:\n \
    \       minutes: 2\n  action:\n    - service: notify.homelab_alerts\n      data:\n\
    \        title: \"Service Down\"\n        message: \"{{ trigger.to_state.attributes.friendly_name\
    \ }} is down\"\n        \n- id: daily_backup_trigger\n  alias: \"Daily Backup\
    \ Trigger\"\n  trigger:\n    platform: time\n    at: \"02:00:00\"\n  action:\n\
    \    - service: switch.turn_on\n      entity_id: switch.homelab_backup\n    -\
    \ service: input_boolean.turn_on\n      entity_id: input_boolean.backup_running\n\
    \      \n- id: optimize_power_consumption\n  alias: \"Optimize Power Consumption\"\
    \n  trigger:\n    platform: time_pattern\n    minutes: \"/30\"  # Every 30 minutes\n\
    \  condition:\n    condition: numeric_state\n    entity_id: sensor.cluster_power_consumption\n\
    \    above: 90\n  action:\n    - service: shell_command.restart_service\n    \
    \  data:\n        service_name: \"performance-tuner\"\n        namespace: \"performance\"\
    \n        \n- id: temperature_too_high_alert\n  alias: \"Temperature Too High\
    \ Alert\"\n  trigger:\n    - platform: numeric_state\n      entity_id: sensor.living_room_temperature\n\
    \      above: 28\n      for:\n        minutes: 5\n    - platform: numeric_state\n\
    \      entity_id: sensor.bedroom_temperature\n      above: 28\n      for:\n  \
    \      minutes: 5\n  action:\n    - service: notify.homelab_alerts\n      data:\n\
    \        title: \"High Temperature Alert\"\n        message: \"{{ trigger.to_state.attributes.friendly_name\
    \ }} is {{ trigger.to_state.state }}\xB0C\"\n    - service: climate.set_temperature\n\
    \      target:\n        entity_id: >\n          {% if 'living_room' in trigger.entity_id\
    \ %}\n            climate.living_room_thermostat\n          {% elif 'bedroom'\
    \ in trigger.entity_id %}\n            climate.bedroom_thermostat\n          {%\
    \ endif %}\n      data:\n        temperature: 24\n        \n- id: temperature_too_low_alert\n\
    \  alias: \"Temperature Too Low Alert\"\n  trigger:\n    - platform: numeric_state\n\
    \      entity_id: sensor.living_room_temperature\n      below: 16\n      for:\n\
    \        minutes: 10\n    - platform: numeric_state\n      entity_id: sensor.bedroom_temperature\n\
    \      below: 16\n      for:\n        minutes: 10\n  action:\n    - service: notify.homelab_alerts\n\
    \      data:\n        title: \"Low Temperature Alert\"\n        message: \"{{\
    \ trigger.to_state.attributes.friendly_name }} is {{ trigger.to_state.state }}\xB0\
    C\"\n    - service: climate.set_temperature\n      target:\n        entity_id:\
    \ >\n          {% if 'living_room' in trigger.entity_id %}\n            climate.living_room_thermostat\n\
    \          {% elif 'bedroom' in trigger.entity_id %}\n            climate.bedroom_thermostat\n\
    \          {% endif %}\n      data:\n        temperature: 20\n        \n- id:\
    \ hvac_energy_optimization\n  alias: \"HVAC Energy Optimization\"\n  trigger:\n\
    \    platform: time_pattern\n    minutes: \"/15\"  # Every 15 minutes\n  condition:\n\
    \    - condition: numeric_state\n      entity_id: sensor.total_hvac_energy\n \
    \     above: 5  # More than 5 kWh today\n    - condition: time\n      after: \"\
    08:00:00\"\n      before: \"22:00:00\"\n  action:\n    - service: climate.set_hvac_mode\n\
    \      target:\n        entity_id: climate.main_hvac_zone\n      data:\n     \
    \   hvac_mode: \"auto\"\n    - service: climate.set_temperature\n      target:\n\
    \        entity_id: climate.main_hvac_zone\n      data:\n        temperature:\
    \ >\n          {% set outdoor_temp = states('sensor.outdoor_temperature') | float(20)\
    \ %}\n          {% if outdoor_temp > 25 %}\n            26  # Raise cooling target\
    \ when it's hot outside\n          {% elif outdoor_temp < 10 %}\n            19\
    \  # Lower heating target when it's cold outside\n          {% else %}\n     \
    \       22  # Normal target\n          {% endif %}\n          \n- id: server_room_cooling\n\
    \  alias: \"Server Room Cooling\"\n  trigger:\n    platform: numeric_state\n \
    \   entity_id: sensor.server_room_temperature\n    above: 25\n    for:\n     \
    \ minutes: 2\n  action:\n    - service: switch.turn_on\n      entity_id: switch.server_room_fan\n\
    \    - service: notify.homelab_alerts\n      data:\n        title: \"Server Room\
    \ Cooling Activated\"\n        message: \"Server room temperature is {{ states('sensor.server_room_temperature')\
    \ }}\xB0C\"\n        \n- id: hvac_maintenance_reminder\n  alias: \"HVAC Maintenance\
    \ Reminder\"\n  trigger:\n    platform: time\n    at: \"08:00:00\"\n  condition:\n\
    \    condition: template\n    value_template: \"{{ now().day == 1 }}\"  # First\
    \ day of month\n  action:\n    - service: notify.homelab_alerts\n      data:\n\
    \        title: \"HVAC Maintenance Reminder\"\n        message: \"Monthly HVAC\
    \ maintenance check due. Runtime this month: {{ states('sensor.total_hvac_runtime_today')\
    \ }} hours\"\n        \n- id: energy_saving_night_mode\n  alias: \"Energy Saving\
    \ Night Mode\"\n  trigger:\n    - platform: time\n      at: \"22:00:00\"\n  action:\n\
    \    - service: climate.set_temperature\n      target:\n        entity_id: \n\
    \          - climate.living_room_thermostat\n          - climate.main_hvac_zone\n\
    \      data:\n        temperature: 19  # Lower temp at night for energy savings\n\
    \    - service: climate.set_temperature\n      target:\n        entity_id: climate.bedroom_thermostat\n\
    \      data:\n        temperature: 18  # Even lower for sleeping\n        \n-\
    \ id: energy_saving_morning_mode\n  alias: \"Energy Saving Morning Mode\"\n  trigger:\n\
    \    - platform: time\n      at: \"06:00:00\"\n  action:\n    - service: climate.set_temperature\n\
    \      target:\n        entity_id:\n          - climate.living_room_thermostat\n\
    \          - climate.bedroom_thermostat\n          - climate.main_hvac_zone\n\
    \      data:\n        temperature: 21  # Comfortable morning temp\n"
  scripts.yaml: "# Homelab Scripts\n\nhomelab_health_check:\n  alias: \"Homelab Health\
    \ Check\"\n  sequence:\n    - service: homeassistant.update_entity\n      entity_id:\
    \ \n        - sensor.cluster_cpu_usage\n        - sensor.cluster_memory_usage\n\
    \        - sensor.cluster_power_consumption\n        - binary_sensor.dashboard_health\n\
    \        - binary_sensor.ml_serving_health\n        - binary_sensor.monitoring_health\n\
    \    - delay: '00:00:05'\n    - service: notify.homelab_alerts\n      data:\n\
    \        title: \"Health Check Complete\"\n        message: >\n          CPU:\
    \ {{ states('sensor.cluster_cpu_usage') }}%\n          Memory: {{ states('sensor.cluster_memory_usage')\
    \ }}%\n          Power: {{ states('sensor.cluster_power_consumption') }}W\n  \
    \        \nhomelab_restart_services:\n  alias: \"Restart Homelab Services\"\n\
    \  sequence:\n    - service: shell_command.restart_service\n      data:\n    \
    \    service_name: \"dashboard-ui\"\n        namespace: \"default\"\n    - delay:\
    \ '00:00:10'\n    - service: shell_command.restart_service\n      data:\n    \
    \    service_name: \"dashboard-api\"\n        namespace: \"default\"\n       \
    \ \nhomelab_backup_now:\n  alias: \"Backup Now\"\n  sequence:\n    - service:\
    \ shell_command.trigger_backup\n    - service: input_boolean.turn_on\n      entity_id:\
    \ input_boolean.backup_running\n    - delay: '00:05:00'\n    - service: input_boolean.turn_off\n\
    \      entity_id: input_boolean.backup_running\n"
  scenes.yaml: "# Homelab Scenes\n\n- name: \"Normal Operation\"\n  entities:\n  \
    \  input_boolean.backup_running: false\n    \n- name: \"Maintenance Mode\"\n \
    \ entities:\n    input_boolean.backup_running: true\n"
  groups.yaml: "# Homelab Groups\n\nhomelab_overview:\n  name: \"Homelab Overview\"\
    \n  entities:\n    - sensor.cluster_cpu_usage\n    - sensor.cluster_memory_usage\n\
    \    - sensor.cluster_power_consumption\n    - sensor.gpu_utilization\n    - sensor.homelab_efficiency\n\
    \    \nhomelab_services:\n  name: \"Homelab Services\"\n  entities:\n    - binary_sensor.dashboard_health\n\
    \    - binary_sensor.ml_serving_health\n    - binary_sensor.monitoring_health\n\
    \    \nhomelab_controls:\n  name: \"Homelab Controls\"\n  entities:\n    - switch.homelab_backup\n\
    \    - input_boolean.backup_running\n    \ntemperature_monitoring:\n  name: \"\
    Temperature Monitoring\"\n  entities:\n    - sensor.living_room_temperature\n\
    \    - sensor.bedroom_temperature\n    - sensor.kitchen_temperature\n    - sensor.office_temperature\n\
    \    - sensor.server_room_temperature\n    - sensor.average_indoor_temperature\n\
    \    \nhumidity_monitoring:\n  name: \"Humidity Monitoring\"\n  entities:\n  \
    \  - sensor.living_room_humidity\n    - sensor.bedroom_humidity\n    - sensor.kitchen_humidity\n\
    \    \nhvac_controls:\n  name: \"HVAC Controls\"\n  entities:\n    - climate.living_room_thermostat\n\
    \    - climate.bedroom_thermostat\n    - climate.main_hvac_zone\n    - climate.server_room_thermostat\n\
    \    \nhvac_monitoring:\n  name: \"HVAC Monitoring\"\n  entities:\n    - sensor.main_hvac_power\n\
    \    - sensor.zone_1_hvac_power\n    - sensor.zone_2_hvac_power\n    - sensor.total_hvac_energy\n\
    \    - sensor.total_hvac_runtime_today\n    - sensor.hvac_efficiency_score\n \
    \   \nenergy_monitoring:\n  name: \"Energy Monitoring\"\n  entities:\n    - sensor.total_hvac_energy\n\
    \    - sensor.lighting_energy\n    - sensor.cluster_power_consumption\n"
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres
  namespace: smart-home
spec:
  serviceName: postgres
  replicas: 1
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
    spec:
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            preference:
              matchExpressions:
              - key: kubernetes.io/arch
                operator: In
                values:
                - arm64
      containers:
      - name: postgres
        image: postgres:15-alpine
        env:
        - name: POSTGRES_DB
          value: homeassistant
        - name: POSTGRES_USER
          value: homeassistant
        - name: POSTGRES_PASSWORD
          value: homeassistant
        - name: PGDATA
          value: /var/lib/postgresql/data/pgdata
        ports:
        - containerPort: 5432
          name: postgres
        volumeMounts:
        - name: postgres-data
          mountPath: /var/lib/postgresql/data
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 1Gi
  volumeClaimTemplates:
  - metadata:
      name: postgres-data
    spec:
      accessModes:
      - ReadWriteOnce
      storageClassName: local-path
      resources:
        requests:
          storage: 20Gi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: node-red
  namespace: smart-home
spec:
  replicas: 1
  selector:
    matchLabels:
      app: node-red
  template:
    metadata:
      labels:
        app: node-red
    spec:
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            preference:
              matchExpressions:
              - key: kubernetes.io/arch
                operator: In
                values:
                - arm
      containers:
      - name: node-red
        image: nodered/node-red:latest
        ports:
        - containerPort: 1880
          name: web
        env:
        - name: TZ
          value: America/New_York
        volumeMounts:
        - name: data
          mountPath: /data
        resources:
          requests:
            cpu: 50m
            memory: 128Mi
          limits:
            cpu: 200m
            memory: 512Mi
      volumes:
      - name: data
        persistentVolumeClaim:
          claimName: node-red-data
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: esphome
  namespace: smart-home
spec:
  replicas: 1
  selector:
    matchLabels:
      app: esphome
  template:
    metadata:
      labels:
        app: esphome
    spec:
      containers:
      - name: esphome
        image: esphome/esphome:latest
        ports:
        - containerPort: 6052
          name: web
        env:
        - name: ESPHOME_DASHBOARD_USE_PING
          value: 'true'
        volumeMounts:
        - name: config
          mountPath: /config
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 1Gi
      volumes:
      - name: config
        persistentVolumeClaim:
          claimName: esphome-config
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: zigbee2mqtt
  namespace: smart-home
spec:
  replicas: 1
  selector:
    matchLabels:
      app: zigbee2mqtt
  template:
    metadata:
      labels:
        app: zigbee2mqtt
    spec:
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            preference:
              matchExpressions:
              - key: kubernetes.io/arch
                operator: In
                values:
                - arm
      initContainers:
      - name: init-config
        image: busybox
        command:
        - sh
        - -c
        - |
          if [ ! -f /app/data/configuration.yaml ]; then
            cp /config/configuration.yaml /app/data/configuration.yaml
          fi
        volumeMounts:
        - name: data
          mountPath: /app/data
        - name: config
          mountPath: /config
      containers:
      - name: zigbee2mqtt
        image: koenkk/zigbee2mqtt:latest
        ports:
        - containerPort: 8080
          name: web
        env:
        - name: TZ
          value: America/New_York
        volumeMounts:
        - name: data
          mountPath: /app/data
        resources:
          requests:
            cpu: 50m
            memory: 128Mi
          limits:
            cpu: 200m
            memory: 256Mi
        securityContext:
          privileged: true
      volumes:
      - name: data
        persistentVolumeClaim:
          claimName: zigbee2mqtt-data
      - name: config
        configMap:
          name: zigbee2mqtt-config
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: zigbee2mqtt-config
  namespace: smart-home
data:
  configuration.yaml: "# Zigbee2MQTT Configuration\n\n# Home Assistant integration\n\
    homeassistant: true\n\n# MQTT settings\nmqtt:\n  base_topic: zigbee2mqtt\n  server:\
    \ mqtt://edge-mqtt.edge.svc.cluster.local:1883\n  user: edge\n  password: edgepassword\n\
    \  \n# Serial settings (adjust for your Zigbee adapter)\nserial:\n  port: /dev/ttyUSB0\n\
    \  adapter: zstack\n  \n# Enable frontend\nfrontend:\n  port: 8080\n  \n# Enable\
    \ new device join\npermit_join: false\n\n# Advanced settings\nadvanced:\n  log_level:\
    \ info\n  pan_id: 0x1a62\n  channel: 11\n  network_key: GENERATE\n  \n# Device\
    \ options\ndevice_options:\n  legacy: false\n  \n# Groups\ngroups: groups.yaml\n\
    \n# Devices\ndevices: devices.yaml\n"
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: home-assistant-config
  namespace: smart-home
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: local-path
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: node-red-data
  namespace: smart-home
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
  storageClassName: local-path
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: esphome-config
  namespace: smart-home
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
  storageClassName: local-path
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: zigbee2mqtt-data
  namespace: smart-home
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 2Gi
  storageClassName: local-path
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: media-storage
  namespace: smart-home
spec:
  accessModes:
  - ReadWriteMany
  resources:
    requests:
      storage: 100Gi
  storageClassName: nfs
---
apiVersion: v1
kind: Service
metadata:
  name: home-assistant
  namespace: smart-home
spec:
  selector:
    app: home-assistant
  ports:
  - port: 8123
    targetPort: 8123
---
apiVersion: v1
kind: Service
metadata:
  name: postgres
  namespace: smart-home
spec:
  selector:
    app: postgres
  ports:
  - port: 5432
    targetPort: 5432
---
apiVersion: v1
kind: Service
metadata:
  name: node-red
  namespace: smart-home
spec:
  selector:
    app: node-red
  ports:
  - port: 1880
    targetPort: 1880
---
apiVersion: v1
kind: Service
metadata:
  name: esphome
  namespace: smart-home
spec:
  selector:
    app: esphome
  ports:
  - port: 6052
    targetPort: 6052
---
apiVersion: v1
kind: Service
metadata:
  name: zigbee2mqtt
  namespace: smart-home
spec:
  selector:
    app: zigbee2mqtt
  ports:
  - port: 8080
    targetPort: 8080
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: smart-home-ingress
  namespace: smart-home
spec:
  rules:
  - host: homeassistant.homelab.lan
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: home-assistant
            port:
              number: 8123
  - host: nodered.homelab.lan
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: node-red
            port:
              number: 1880
  - host: esphome.homelab.lan
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: esphome
            port:
              number: 6052
  - host: zigbee.homelab.lan
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: zigbee2mqtt
            port:
              number: 8080
